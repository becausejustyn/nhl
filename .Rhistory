xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#AD1316",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2007-2017",
caption = "Error bars are SEM"
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$team[nrow(above)],
ymin = above$team[1],
fill = "#2E8F48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#AD1316",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
pull(df1_summary_5_v_4, season) %>% range()
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2008-2021",
caption = "Error bars are SEM \n Seattle excluded due to number of games."
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$team[nrow(above)],
ymin = above$team[1],
fill = "#2E8F48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#AD1316",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2008-2021",
caption = "Error bars are SEM \n Seattle excluded due to number of games."
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$team[nrow(above)],
ymin = above$team[1],
fill = "#486e48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#346991",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
gc()
library(visibly)
# set the theme as default
theme_set(theme_clean())
# set other point/line default colors; in most cases, we can use the color from
# default discrete scale for more consistency across plots.
update_geom_defaults('vline',   list(colour = 'gray25',  alpha = .25))  # vlines and hlines are typically not attention grabbers so set alpha
update_geom_defaults('hline',   list(colour = 'gray25',  alpha = .25))  # usually a zero marker
update_geom_defaults('point',   list(colour = '#E69F00', alpha = .5))   # alpha as usually there are many points
update_geom_defaults('line',    list(colour = '#E69F00'))
update_geom_defaults('bar',     list(color  = '#E69F00', fill = '#E69F00'))
update_geom_defaults('col',     list(color  = '#E69F00', fill = '#E69F00'))
update_geom_defaults('smooth',  list(color  = '#E69F00', alpha = .15))
update_geom_defaults('dotplot', list(color  = '#E69F00', fill = '#E69F00'))
ggplot <- function(...) ggplot2::ggplot(...) +
# brewer bonus is that it is already part of ggplot2
# scale_color_brewer(palette = 'Dark2', drop = FALSE, aesthetics = c('color', 'fill'))
# okabe ito colorblind safe scheme
scale_color_manual(
values = c(
'#E69F00',
'#56B4E9',
'#009E73',
'#F0E442',
'#0072B2',
'#D55E00',
'#CC79A7',
'#999999'
),
drop = FALSE,
aesthetics = c('color', 'fill')
)
gt <- function(..., decimals = 2) {
gt::gt(...) %>%
gt::fmt_number(
columns = where(is.numeric),
decimals = decimals
) %>%
gtExtras::gt_theme_nytimes()
}
#rnd = tidyext::rnd
library(tidyverse)
library(broom)
library(kableExtra)
library(visibly)
# set the theme as default
theme_set(theme_clean())
# set other point/line default colors; in most cases, we can use the color from
# default discrete scale for more consistency across plots.
update_geom_defaults('vline',   list(colour = 'gray25',  alpha = .25))  # vlines and hlines are typically not attention grabbers so set alpha
update_geom_defaults('hline',   list(colour = 'gray25',  alpha = .25))  # usually a zero marker
update_geom_defaults('point',   list(colour = '#E69F00', alpha = .5))   # alpha as usually there are many points
update_geom_defaults('line',    list(colour = '#E69F00'))
update_geom_defaults('bar',     list(color  = '#E69F00', fill = '#E69F00'))
update_geom_defaults('col',     list(color  = '#E69F00', fill = '#E69F00'))
update_geom_defaults('smooth',  list(color  = '#E69F00', alpha = .15))
update_geom_defaults('dotplot', list(color  = '#E69F00', fill = '#E69F00'))
ggplot <- function(...) ggplot2::ggplot(...) +
# brewer bonus is that it is already part of ggplot2
# scale_color_brewer(palette = 'Dark2', drop = FALSE, aesthetics = c('color', 'fill'))
# okabe ito colorblind safe scheme
scale_color_manual(
values = c(
'#E69F00',
'#56B4E9',
'#009E73',
'#F0E442',
'#0072B2',
'#D55E00',
'#CC79A7',
'#999999'
),
drop = FALSE,
aesthetics = c('color', 'fill')
)
gt <- function(..., decimals = 2) {
gt::gt(...) %>%
gt::fmt_number(
columns = where(is.numeric),
decimals = decimals
) %>%
gtExtras::gt_theme_nytimes()
}
#rnd = tidyext::rnd
nc = ncol(mtcars)
nr = nc
fit_perfect = lm(mpg ~ ., mtcars[1:nr, ])
# summary(fit_perfect) # not shown, all inferential estimates are NaN
pseudo_inv = psych::Pinv
fit_ridgeless = function(X_train, y, X_test, y_test){
# get the coefficient estimates
b = pseudo_inv(crossprod(X_train)) %*% crossprod(X_train, y)
# get training/test predictions
predictions_train = X_train %*% b
predictions_test  = X_test %*% b
# get training/test error
rmse_train = sqrt(mean((y - predictions_train[,1])^2))
rmse_test  = sqrt(mean((y_test - predictions_test[,1])^2))
# return result
list(
b = b,
predictions_train = predictions_train,
predictions_test  = predictions_test,
rmse_train = rmse_train,
rmse_test  = rmse_test
)
}
n = 10
X = as.matrix(cbind(1, mtcars[, -1]))
y = mtcars$mpg # mpg is the first column
X_train = X[1:n, ]
y_train = mtcars$mpg[1:n]
X_test  = X[-(1:n),]
y_test  = y[-(1:n)]
result = fit_ridgeless(X_train, y_train, X_test, y_test)
styler:::style_selection()
library(tidyverse)
library(RCurl)
library(broom)
library(gridExtra)
library(knitr)
library(kableExtra)
library(RColorBrewer)
link <- 'https://raw.githubusercontent.com/mkmiecik14/mkmiecik14.github.io/master/data/corsicaData_5v4.csv'
data5v4 <- read.table(text = getURL(link), sep = ',', header = T)
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center')
options(knitr.table.format = 'html') # For the html tables
# Combining ATL and WPG as ATL.WPG
data5v4$Team <- plyr::revalue(data5v4$Team, c(ATL = 'ATL.WPG', WPG = 'ATL.WPG'))
data5v4 <- data5v4 %>%
separate(Season, c('StartYear', 'EndYear'), sep = 4, remove = F) %>%
mutate_at(c('StartYear', 'EndYear'), funs(as.numeric))
data5v4
# Initializing variables to store team names
pacific <- c('S.J', 'CGY', 'L.A', 'ANA', 'EDM', 'VAN', 'ARI')
central <- c('ATL.WPG', 'NSH', 'STL', 'DAL', 'COL', 'MIN', 'CHI')
metropolitan <- c('WSH', 'N.J', 'PHI', 'CBJ', 'PIT', 'NYR', 'NYI', 'CAR')
atlantic <- c('T.B', 'BOS', 'TOR', 'DET', 'MTL', 'FLA', 'OTT', 'BUF')
# Creating a column to identify each team's division
data5v4 <- data5v4 %>%
mutate(division = case_when(data5v4$Team %in% pacific ~ 'Pacific',
data5v4$Team %in% central ~ 'Central',
data5v4$Team %in% metropolitan ~ 'Metropolitan',
data5v4$Team %in% atlantic ~ 'Atlantic'))
# Creates the data frame for html table
divisions <- data.frame(Pacific = c(pacific, ''),
Central = c(central, ''),
Metropolitan = metropolitan,
Atlantic = atlantic)
# Prints table
kable(divisions) %>%
kable_styling(bootstrap_options = c('striped', 'hover', 'responsive'))
ggplot(data5v4, aes(StartYear, GF, group = 1)) +
geom_line(aes(group = Team, color = division), alpha = 2/3) +
geom_line(stat = 'summary', fun.y = 'mean', size = .9, color = 'red') +
scale_color_brewer(palette = 'Blues', direction = -1) +
labs(x = 'Season (Start Year)',
y = 'Total Season Power Play Goals (5v4)',
caption = 'Each team is a separate line; red line is the average') +
guides(color = guide_legend(title = 'Division')) +
scale_x_continuous(limits = c(2007, 2016), breaks = c(2007:2016)) +
theme_minimal()
ggplot(data5v4, aes(StartYear, GF/GP, group = 1)) +
geom_line(aes(group = Team, color = division), alpha = 2/3) +
geom_line(stat = 'summary', fun = 'mean', size = .9, color = 'red') +
scale_color_brewer(palette = 'Blues', direction = -1) +
labs(x = 'Season (Start Year)',
y = 'Total Season Power Play Goals/Games Played (5v4)',
caption = 'Each team is a separate line; red line is the average') +
guides(color = guide_legend(title = 'Division')) +
scale_x_continuous(limits = c(2007, 2016), breaks = c(2007:2016)) +
theme_minimal()
yaxlim <- c(.25,1) # Locks y-axis
# Box plot
boxplot <- ggplot(data5v4, aes(factor(StartYear), GF/GP, group = StartYear)) +
geom_boxplot() +
labs(x = 'Season (Start Year)',
y = 'Total Season Power Play Goals/Games Played (5v4)',
caption = ' ') +
coord_cartesian(ylim = yaxlim) +
theme_minimal()
# Summary for line plot
data5v4_sum <- data5v4 %>%
group_by(StartYear) %>%
summarise(mean = mean(GF/GP),
sd = mean(GF/GP),
n = n(),
sem = sd/sqrt(n))
# Line plot
lineplot <- ggplot(data5v4_sum, aes(factor(StartYear), mean, group = 1)) +
geom_line(alpha = 1/3) +
geom_pointrange(aes(ymax = mean + sem, ymin = mean - sem)) +
coord_cartesian(ylim = yaxlim) +
labs(x = 'Season (Start Year)', caption = 'Error bars are SEM') +
theme_minimal() +
theme(axis.title.y = element_blank())
# Arranges plots side-by-side
grid.arrange(boxplot, lineplot, ncol = 2)
modTeam <-  data5v4 %>%
group_by(Team) %>%
do(level1 = lm((GF/GP) ~ StartYear, data = .))
level1Omni <- modTeam %>% glance(level1) %>% mutate(sig = p.value < .05)
modTeam
modTeam %>% unnest(level1)
data5v4 %>%
group_by(Team) %>%
do(level1 = lm((GF/GP) ~ StartYear, data = .))
modTeam$level1
modTeam$level1[1]
regressions <- mtcars %>%
nest(data = -Team) %>%
mutate(
#lm((GF/GP) ~ StartYear, data = .x)
fit = map(data, ~ lm((GF/GP) ~ StartYear, data = .x)),
#fit = map(data, ~ lm(wt ~ mpg + qsec + gear, data = .x)),
tidied = map(fit, tidy),
glanced = map(fit, glance),
augmented = map(fit, augment)
)
regressions <- data5v4 %>%
nest(data = -Team) %>%
mutate(
#lm((GF/GP) ~ StartYear, data = .x)
fit = map(data, ~ lm((GF/GP) ~ StartYear, data = .x)),
#fit = map(data, ~ lm(wt ~ mpg + qsec + gear, data = .x)),
tidied = map(fit, tidy),
glanced = map(fit, glance),
augmented = map(fit, augment)
)
regressions
regressions %>% glance(fit)
regressions %>% tidy(fit)
regressions %>% unnest(fit)
regressions %>% unnest(glanced)
regressions %>% unnest(glanced) %>% mutate(sig = p.value < .05)
modTeam <- data5v4 %>%
nest(data = -Team) %>%
mutate(
#lm((GF/GP) ~ StartYear, data = .x)
fit = map(data, ~ lm((GF/GP) ~ StartYear, data = .x)),
#fit = map(data, ~ lm(wt ~ mpg + qsec + gear, data = .x)),
tidied = map(fit, tidy),
glanced = map(fit, glance),
augmented = map(fit, augment)
)
level1Omni <- modTeam %>%
unnest(glanced) %>%
mutate(sig = p.value < .05)
# Color palette
sigColorPal <- brewer.pal(11,'RdGy') # display.brewer.pal(11,'RdGy')
# R^2 Plot
ggplot(level1Omni, aes(r.squared, reorder(Team, r.squared), color = sig)) +
geom_point(size = 2) +
scale_color_manual(values = sigColorPal[c(9,2)]) +
labs(x = 'R-squared', y = 'Team') +
guides(color = guide_legend(title = 'p < .05')) +
theme_minimal()
# Extracting level 1 coefficients
level1Coef <- modTeam %>%
tidy(level1) %>%
filter(term == 'StartYear') %>%   # Facilitates plotting
mutate(sig = p.value < .05)       # For later plotting
modTeam
modTeam %>% tidied
modTeam %>% unnest(tidied)
# Extracting level 1 coefficients
level1Coef <- modTeam %>%
unnest(tidied) %>%
filter(term == 'StartYear') %>%   # Facilitates plotting
mutate(sig = p.value < .05)       # For later plotting
ggplot(level1Coef, aes(estimate, reorder(Team, -1*estimate), color = sig)) +
geom_point(size = 2) +
geom_errorbarh(aes(xmin = estimate - std.error,
xmax = estimate + std.error),
alpha = 1/2) +
scale_color_manual(values = sigColorPal[c(9,2)]) +
labs(x = 'Estimate (Yearly Change in Power Play Goals/Game)',
y = 'Team',
caption = 'SEM error bars') +
guides(color = guide_legend(title = 'p < .05')) +
theme_minimal()
# Extracting level 1 model fits
level1Fits <- modTeam %>%
augment(augmented) %>%
ungroup() %>%
mutate(sig = rep(level1Coef$sig, each = length(unique(StartYear))))
# Extracting level 1 model fits
level1Fits <- modTeam %>%
unnest(augmented) %>%
ungroup() %>%
mutate(sig = rep(level1Coef$sig, each = length(unique(StartYear))))
ggplot(level1Fits, aes(StartYear, color = sig)) +
geom_line(aes(y = .fitted), alpha = 2/3) +
scale_color_manual(values = sigColorPal[c(9,2)]) +
geom_line(aes(y = X.GF.GP.), color = 'black') +
labs(x = 'Season (Start Year)',
y = 'Power Play Goals/Games Played (5v4)') +
scale_x_continuous(breaks = c(2008, 2015)) +
facet_wrap(~Team, ncol = 5) +
guides(color = guide_legend(title = 'p < .05')) +
theme_minimal() +
theme(legend.position = 'bottom')
level1Fits
modTeam %>%
unnest(augmented)
modTeam %>% augment(fit)
modTeam %>% augment(tidied)
modTeam %>% augment(glanced)
level1Fits
ggplot(level1Fits, aes(StartYear, color = sig)) +
geom_line(aes(y = .fitted), alpha = 2/3) +
scale_color_manual(values = sigColorPal[c(9,2)]) +
#geom_line(aes(y = X.GF.GP.), color = 'black') +
labs(x = 'Season (Start Year)',
y = 'Power Play Goals/Games Played (5v4)') +
scale_x_continuous(breaks = c(2008, 2015)) +
facet_wrap(~Team, ncol = 5) +
guides(color = guide_legend(title = 'p < .05')) +
theme_minimal() +
theme(legend.position = 'bottom')
level1Fits
level1Fits$data
ggplot(level1Fits, aes(StartYear, color = sig)) +
geom_line(aes(y = .fitted), alpha = 2/3) +
scale_color_manual(values = sigColorPal[c(9,2)]) +
#geom_line(aes(y = X.GF.GP.), color = 'black') +
geom_line(aes(y = level1Fits$data[['X.GF.GP.']]), color = 'black') +
labs(x = 'Season (Start Year)',
y = 'Power Play Goals/Games Played (5v4)') +
scale_x_continuous(breaks = c(2008, 2015)) +
facet_wrap(~Team, ncol = 5) +
guides(color = guide_legend(title = 'p < .05')) +
theme_minimal() +
theme(legend.position = 'bottom')
level1Fits$data[['X.GF.GP.']]
modTeam$data
modTeam$data[['X.GF.GP.']]
