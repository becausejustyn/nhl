labs(
x = "Season",
y = "Total Season Power Play Goals/Games Played (5v4)"
) +
stat_smooth(method = 'lm', col = '#984ea3', se = FALSE, size = 1) +
theme(axis.text.x = element_text(angle = 15, hjust = 1)) +
hrbrthemes::theme_ft_rc()
resid(mod) %>% length()
df1_summary_5_v_4 %>% dim()
df1_summary_5_v_4 %>%
mutate(
rel_ppg = resid(mod)
)
df1_summary_5_v_4 <- df1_summary_5_v_4 %>%
mutate(rel_ppg = resid(mod))
f1_summary_5_v_4 %>%
group_by(team) %>%
summarise(
mean = mean(rel_ppg),
sd = sd(rel_ppg),
sem = sd(rel_ppg)/sqrt(n()),
tpval = t.test(rel_ppg)$p.value
) %>%
mutate(sig = tpval < .05)
df1_summary_5_v_4 %>%
group_by(team) %>%
summarise(
mean = mean(rel_ppg),
sd = sd(rel_ppg),
sem = sd(rel_ppg)/sqrt(n()),
tpval = t.test(rel_ppg)$p.value
) %>%
mutate(sig = tpval < .05)
df1_summary_5_v_4 %>%
filter(team != 'SEA') %>%
group_by(team) %>%
summarise(
mean = mean(rel_ppg),
sd = sd(rel_ppg),
sem = sd(rel_ppg)/sqrt(n()),
tpval = t.test(rel_ppg)$p.value
) %>%
mutate(sig = tpval < .05)
bestPP <- df1_summary_5_v_4 %>%
# Seattle have not played enough games
filter(team != 'SEA') %>%
group_by(team) %>%
summarise(
mean = mean(rel_ppg),
sd = sd(rel_ppg),
sem = sd(rel_ppg)/sqrt(n()),
tpval = t.test(rel_ppg)$p.value
) %>%
mutate(sig = tpval < .05)
bestPPSort <- arrange(bestPP, mean)
axisFace <- ifelse(bestPPSort$sig == TRUE, 'bold', 'plain')
# -- To get y.axis bold conditional -- #
# -- To get shading conditional -- #
above <- bestPP %>%
filter(mean > 0, sig == TRUE) %>%
arrange(mean)
average <- bestPP %>%
filter(sig == FALSE)
below <- bestPP %>%
filter(mean < 0, sig == TRUE) %>%
arrange(mean)
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(Team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2007-2017",
caption = "Error bars are SEM"
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$Team[nrow(above)],
ymin = above$Team[1],
fill = "#2E8F48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$Team[nrow(below)],
ymin = below$Team[1],
fill = "#AD1316",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$Team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$Team[4], label = "Worst Teams")
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(Team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2007-2017",
caption = "Error bars are SEM"
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$team[nrow(above)],
ymin = above$team[1],
fill = "#2E8F48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#AD1316",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(Team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2007-2017",
caption = "Error bars are SEM"
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$team[nrow(above)],
ymin = above$team[1],
fill = "#2E8F48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#AD1316",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2007-2017",
caption = "Error bars are SEM"
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$team[nrow(above)],
ymin = above$team[1],
fill = "#2E8F48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#AD1316",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
pull(df1_summary_5_v_4, season) %>% range()
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2008-2021",
caption = "Error bars are SEM \n Seattle excluded due to number of games."
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$team[nrow(above)],
ymin = above$team[1],
fill = "#2E8F48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#AD1316",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
bestPP %>%
ggplot(aes(
x = mean,
y = reorder(team, mean),
colour = sig
)) +
geom_errorbarh(aes(
xmin = mean - sem,
xmax = mean + sem
)) +
geom_point(size = 2) +
scale_x_continuous(limits = (c(-.2, .2))) +
scale_color_manual(
values = c("grey", "black"),
guide = guide_legend(
reverse = TRUE,
title = "Above/Below Average",
title.position = "top"
)
) +
labs(
x = "Mean Power Play Goals/Games Played (Residuals)",
y = "NHL Team",
title = "NHL 5v4 Power Play Team Performance 2008-2021",
caption = "Error bars are SEM \n Seattle excluded due to number of games."
) +
hrbrthemes::theme_ft_rc() +
theme(
axis.text.y = element_text(face = axisFace),
plot.title = element_text(hjust = 0.5),
legend.position = "none",
legend.key = element_rect(colour = "transparent", fill = "white"),
legend.key.width = unit(1, "in"),
legend.key.height = unit(.5, "in"),
legend.title.align = .5,
axis.title.x = element_text(vjust = -1)
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = above$team[nrow(above)],
ymin = above$team[1],
fill = "#486e48",
alpha = 1 / 3
) +
annotate("rect",
xmin = -Inf,
xmax = Inf,
ymax = below$team[nrow(below)],
ymin = below$team[1],
fill = "#346991",
alpha = 1 / 3
) +
annotate("text", x = -.1, y = above$team[3], label = "Best Teams") +
annotate("text", x = .1, y = below$team[4], label = "Worst Teams")
gc()
library(visibly)
# set the theme as default
theme_set(theme_clean())
# set other point/line default colors; in most cases, we can use the color from
# default discrete scale for more consistency across plots.
update_geom_defaults('vline',   list(colour = 'gray25',  alpha = .25))  # vlines and hlines are typically not attention grabbers so set alpha
update_geom_defaults('hline',   list(colour = 'gray25',  alpha = .25))  # usually a zero marker
update_geom_defaults('point',   list(colour = '#E69F00', alpha = .5))   # alpha as usually there are many points
update_geom_defaults('line',    list(colour = '#E69F00'))
update_geom_defaults('bar',     list(color  = '#E69F00', fill = '#E69F00'))
update_geom_defaults('col',     list(color  = '#E69F00', fill = '#E69F00'))
update_geom_defaults('smooth',  list(color  = '#E69F00', alpha = .15))
update_geom_defaults('dotplot', list(color  = '#E69F00', fill = '#E69F00'))
ggplot <- function(...) ggplot2::ggplot(...) +
# brewer bonus is that it is already part of ggplot2
# scale_color_brewer(palette = 'Dark2', drop = FALSE, aesthetics = c('color', 'fill'))
# okabe ito colorblind safe scheme
scale_color_manual(
values = c(
'#E69F00',
'#56B4E9',
'#009E73',
'#F0E442',
'#0072B2',
'#D55E00',
'#CC79A7',
'#999999'
),
drop = FALSE,
aesthetics = c('color', 'fill')
)
gt <- function(..., decimals = 2) {
gt::gt(...) %>%
gt::fmt_number(
columns = where(is.numeric),
decimals = decimals
) %>%
gtExtras::gt_theme_nytimes()
}
#rnd = tidyext::rnd
library(tidyverse)
library(broom)
library(kableExtra)
library(visibly)
# set the theme as default
theme_set(theme_clean())
# set other point/line default colors; in most cases, we can use the color from
# default discrete scale for more consistency across plots.
update_geom_defaults('vline',   list(colour = 'gray25',  alpha = .25))  # vlines and hlines are typically not attention grabbers so set alpha
update_geom_defaults('hline',   list(colour = 'gray25',  alpha = .25))  # usually a zero marker
update_geom_defaults('point',   list(colour = '#E69F00', alpha = .5))   # alpha as usually there are many points
update_geom_defaults('line',    list(colour = '#E69F00'))
update_geom_defaults('bar',     list(color  = '#E69F00', fill = '#E69F00'))
update_geom_defaults('col',     list(color  = '#E69F00', fill = '#E69F00'))
update_geom_defaults('smooth',  list(color  = '#E69F00', alpha = .15))
update_geom_defaults('dotplot', list(color  = '#E69F00', fill = '#E69F00'))
ggplot <- function(...) ggplot2::ggplot(...) +
# brewer bonus is that it is already part of ggplot2
# scale_color_brewer(palette = 'Dark2', drop = FALSE, aesthetics = c('color', 'fill'))
# okabe ito colorblind safe scheme
scale_color_manual(
values = c(
'#E69F00',
'#56B4E9',
'#009E73',
'#F0E442',
'#0072B2',
'#D55E00',
'#CC79A7',
'#999999'
),
drop = FALSE,
aesthetics = c('color', 'fill')
)
gt <- function(..., decimals = 2) {
gt::gt(...) %>%
gt::fmt_number(
columns = where(is.numeric),
decimals = decimals
) %>%
gtExtras::gt_theme_nytimes()
}
#rnd = tidyext::rnd
nc = ncol(mtcars)
nr = nc
fit_perfect = lm(mpg ~ ., mtcars[1:nr, ])
# summary(fit_perfect) # not shown, all inferential estimates are NaN
pseudo_inv = psych::Pinv
fit_ridgeless = function(X_train, y, X_test, y_test){
# get the coefficient estimates
b = pseudo_inv(crossprod(X_train)) %*% crossprod(X_train, y)
# get training/test predictions
predictions_train = X_train %*% b
predictions_test  = X_test %*% b
# get training/test error
rmse_train = sqrt(mean((y - predictions_train[,1])^2))
rmse_test  = sqrt(mean((y_test - predictions_test[,1])^2))
# return result
list(
b = b,
predictions_train = predictions_train,
predictions_test  = predictions_test,
rmse_train = rmse_train,
rmse_test  = rmse_test
)
}
n = 10
X = as.matrix(cbind(1, mtcars[, -1]))
y = mtcars$mpg # mpg is the first column
X_train = X[1:n, ]
y_train = mtcars$mpg[1:n]
X_test  = X[-(1:n),]
y_test  = y[-(1:n)]
result = fit_ridgeless(X_train, y_train, X_test, y_test)
